============
Placeholders
============


Transifex supports adding
`Translation checks <https://help.transifex.com/en/articles/6241794-setting-translation-checks#h_317a8b70f5>`_
to fit the translation caracteristics.

Adding custom placeholders causes the matched expression to be highlighted, be assigned unique numbers in that string,
and to be warned if translation differs from the source string.

Some notes:
    - Some roles allow being renamed (e.g. "\:ref:\`this is a rename text <actual-link>\`_"), and the renamed text
      has great chance of being translatable. Hence, these roles that have whitespaces were not added to the list
      of place holders, and will be rendered as normal text.
    - The roles :dfn: and :term: were not included because their content are normally translatable, so making them
      placeholders would pop up too many false-positive warnings.
    - \``$\`` is being wrongly replaced with the placeholder ```{TX-PL-LABEL}#x60;``` by Transifex because of the 
      custom placeholder that starts and ends with \``. Removing this custom placeholder ceases the issue, but it
      disables custom placeholders for all literal expressions.

About order of placeholders expression matching:
    - Transifex match text to custom placeholders expression from top-down, which means first expressions added as
      custom placeholder will take precedence over the expression below. This means the order must be chosen wisely
      to avoid unexpected mismatch of placeholders.
    - For each category of placeholder expression, consider puting the most used before others (e.g. ``:class:`` before ``:2to3fixer:``)
    - Order suggestion:
      - two-part roles (e.g. ``:c:func:` ``)
      - one-part roles (e.g. ``:class:` ``)
      - literals starting with two dashes (e.g. \`\`--bind``)
      - literals starting with one dash (e.g. \`\`-n``)
      - literals (e.g. \`\`None``)
      - Sphinx variables with links (e.g. ``|tzdata|_``)
      - Sphinx variables (without links) (e.g. ``|version|``)


Get a list of potential placeholders
------------------------------------

Extract strings from docs
~~~~~~~~~~~~~~~~~~~~~~~~~

To make easier to read the source strings, extract them from the doc files and put it in a temporary file.

1. Before extracting, you need to get source repositories, install dependencies and then generate POT files:

.. code-block:: shell

   git clone https://github.com/rffontenelle/python-docs-tx-translations
   cd python-docs-tx-translations
   git clone --depth 1 --branch 3.12 https://github.com/python/cpython
   python -mvenv venv
   source venv/bin/activate
   pip install -r requirements.txt -r cpython/Doc/requirements.txt
   sphinx-build -E -b gettext -D gettext_compact=0 -d build/.doctrees . locales/pot

2. Now get the sources strings from POT files into a *strings.txt*

.. code-block:: shell

   for pot in $(find locales/pot -name '*.pot'); do (msgcat --no-wrap $pot > tmp; mv tmp $pot;); done
   grep -h ^msgid $(find locales/pot -name '*.pot') | sed 's|^msgid "||;s|"$||;/^$/d' > strings.txt
   git checkout locale

Now, *strings.txt* have all source strings.

Find pontential placeholders from extracted strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use the following commands to find potential custom

1. To list two-part roles (e.g. `:c:func:\` `)::

.. code-block:: shell
   
   grep -Po '(^|\s+):([\w\-\_\~]*:){2}`' strings.txt | sed -E 's|^ +||;' | sort | uniq -c | sort -grk 1

2. To list one-part roles (e.g. `:class:\` `):

.. code-block:: shell

   grep -Po '(^|\s+):[\w\-\_\~]*:`' strings.txt | sed -E 's|^ +||;' | sort | uniq -c | sort -grk 1

3. To list Sphinx variables with links (e.g. \|tzdata\|_):

.. code-block:: shell

   grep -Po '\|[\w\_\-]*\|_' strings.txt | sed -E 's|^ +||;' | sort | uniq -c | sort -grk 1

4. Now, to list Sphinx variables with links (e.g. \|version\|):

.. code-block:: shell

   grep -Po '\|[\w\_\-]*\|' strings.txt | sed -E 's|^ +||;' | sort | uniq -c | sort -grk 1

.. note::

  Put \`\`literals\`\` before Sphinx \|variables| (with and without links) in the list of custom placeholders in Transifex, otherwise the expression of a non-variable from inside a literal expression might match before actually match the literal itself.

Current Custom Placeholders
---------------------------

This is the list of roles and variables currently set in python-doc organization in Transifex.

+---------------+--------------+---------------------+--------------------------------------------------------------------+
| Starts with   | Ends with    | Allows whitespace   | Note                                                               |
+===============+==============+=====================+====================================================================+
| :c:data:`     | \`           | no                  | Here start two-part roles. These **must** be inserted before       |
|               |              |                     | one-part roles because Transifex placeholders are detected         |
|               |              |                     | according to their order; otherwise one-part role will match       |
|               |              |                     | when not wanted (e.g. the ":data:`" will excluding the ":c:")     |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:expr:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:func:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:macro:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:member:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:struct:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:type:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :c:var:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:attr:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:class:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:data:`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:func:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:meth:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :py:mod:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :2to3fixer:\` | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :abbr:\`      | \`           | no                  | Here start the one-part roles.                                     |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :attr:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :class:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :code:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :command:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :const:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :data:`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :doc:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :download:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :envvar:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :exc:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :expr:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :file:`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :func:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :gh:\`        | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :guilabel:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :issue:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :kbd:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :keyword:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :macro:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :mailheader:\`| \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :makevar:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :member:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :meth:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :mimetype:\`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :mod:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :newsgroup:\` | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :opcode:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :pdbcmd:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :pep:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :program:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :ref:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :rfc:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :source:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :struct:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :sub:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :sup:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :type:\`      | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :var:\`       | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :manpage:\`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :option:\`    | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :option:\--`  | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :option:\-`   | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :samp:\`      | \`           | yes                 | This role normally presents shell commands and as such normally    |
|               |              |                     | includes whitespaces. It possible includes pseudo-variables that   |
|               |              |                     | should be translated.                                              |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| :token:\`     | \`           | no                  |                                                                    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \``--         | \``          | yes                 | This is literal role to match double-dash command-line options.    |
|               |              |                     | Must come before single-dash one because Transifex placeholders    |
|               |              |                     | are detected according to their order.                             |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \``-          | \``          | yes                 | This is literal role to match single-dash command-line options.    |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \``           | \``          | yes                 | This matches all literals, and spaces should be allowed.           |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \|nbs         | \|           | no                  | Here start Sphinx variables.                                       |
|               |              |                     | This is for '\|nbsp\|'.                                            |
|               |              |                     | Since Transifex doesn't allow adding the whole variable as         |
|               |              |                     | placeholder, I omit the last character of the variable as a        |
|               |              |                     | workaround                                                         |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \|releas      | \|           | no                  | This is for '\|release\|'                                          |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \|toda        | \|           | no                  | This is for '\|today\|'                                            |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \|tzdat       | \|_          | no                  | This is for '\|tzdata\|_'. This variable is used as a URL, hence   |
|               |              |                     | the trailing '_'                                                   |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
| \|versio      | \|           | no                  | This is for '\|version\|'                                          |
+---------------+--------------+---------------------+--------------------------------------------------------------------+
